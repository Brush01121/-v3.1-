<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ ì„¸ê³„ì˜ ì„¤ê³„ì: ë§ˆìŠ¤í„° ì—ë””ì…˜ v3.1</title>
    <style>
        :root {
            --bg-color: #0f172a; --card-bg: #ffffff;
            --text-dark: #1e293b; --text-light: #f8fafc;
            --accent: #3b82f6;
            --pros: #fbbf24; --nat: #22c55e; --har: #8b5cf6; --sec: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-light); height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes shake { 0% { transform: translate(1px, 1px); } 20% { transform: translate(-3px, 0px); } 40% { transform: translate(3px, 2px); } 100% { transform: translate(0,0); } }
        .shake { animation: shake 0.2s ease-in-out; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .danger-pulse { animation: pulse 0.6s infinite; border: 2px solid var(--sec) !important; }

        .screen { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; padding: 20px; background: var(--bg-color); }
        .screen.active { display: flex !important; }

        #start-screen h1 { font-size: clamp(2rem, 8vw, 3.5rem); margin-bottom: 10px; text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); text-align: center; }
        .menu-btn { width: 280px; padding: 18px; margin: 8px; border-radius: 15px; border: none; background: #1e293b; color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; border: 1px solid #334155; }
        .menu-btn:hover { background: var(--accent); transform: translateY(-3px); }
        .point-display { margin-top: 20px; font-size: 1.2rem; color: var(--pros); font-weight: bold; }

        #game-wrapper { display: none; width: 100%; max-width: 1200px; height: 95vh; gap: 20px; padding: 20px; }
        #game-wrapper.active { display: flex !important; }
        #game-main { flex: 2; display: flex; flex-direction: column; align-items: center; position: relative; }
        
        #game-log-panel { flex: 1; background: rgba(30, 41, 59, 0.5); border-radius: 20px; border: 1px solid #334155; display: flex; flex-direction: column; overflow: hidden; }
        #log-header { padding: 15px; background: #1e293b; font-weight: bold; border-bottom: 1px solid #334155; color: #94a3b8; }
        #log-content { flex: 1; padding: 15px; overflow-y: auto; font-size: 0.85rem; color: #cbd5e1; }

        #stat-header { width: 100%; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-box { text-align: center; font-size: 0.7rem; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 12px; transition: 0.3s; border: 1px solid transparent; }
        .stat-val { font-size: 1.1rem; display: block; font-weight: 800; margin-bottom: 4px; }
        .bar-container { height: 6px; background: #334155; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; width: 50%; transition: width 0.3s ease; }

        #card-zone { position: relative; width: 100%; flex: 1; display: flex; justify-content: center; align-items: center; min-height: 400px; }
        .card { 
            position: absolute; width: 340px; height: 450px; background: var(--card-bg); border-radius: 30px; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.5); color: var(--text-dark);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .card-header-title { background: #f1f5f9; padding: 18px; font-size: 1.3rem; font-weight: 900; text-align: center; color: #0f172a; border-bottom: 1px solid #e2e8f0; }
        .card-top-bar { height: 8px; width: 100%; }
        .card-content { padding: 25px; flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; justify-content: center; }
        .card-img { font-size: 5rem; margin: 10px 0; }

        #inventory { display: flex; gap: 12px; margin: 15px 0; }
        .inv-slot { width: 55px; height: 55px; background: #1e293b; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; position: relative; border: 1px solid #334155; cursor: pointer; }
        .inv-count { position: absolute; top: -6px; right: -6px; background: var(--sec); color: white; border-radius: 10px; padding: 2px 7px; font-size: 0.75rem; font-weight: bold; }

        .choice-btn { flex: 1; height: 65px; border-radius: 18px; border: none; color: white; font-weight: 800; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        #btn-L { background: #334155; } #btn-R { background: var(--accent); } #btn-M { background: #64748b; display: none; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; align-items: center; justify-content: center; }
        .modal-content { background: #1e293b; width: 90%; max-width: 450px; padding: 25px; border-radius: 25px; max-height: 85vh; overflow-y: auto; position: relative; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 15px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }

        /* ê²°ê³¼ í™”ë©´: í•˜ì–€ í™”ë©´ ë°©ì§€ ë¡œì§ */
        #game-over-screen { 
            position: fixed; inset: 0; z-index: 9999 !important; 
            background: var(--bg-color) !important; display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
        }
        #game-over-screen.active { display: flex !important; }
    </style>
</head>
<body>

    <div id="start-screen" class="screen active">
        <p style="color: var(--accent); font-weight: 800; letter-spacing: 5px; margin-bottom: 5px;">PROJECT GENESIS</p>
        <h1>ì‹ ì„¸ê³„ì˜ ì„¤ê³„ì</h1>
        <div style="margin-bottom: 20px;">
            <select id="difficulty-select" style="background: #1e293b; color: white; border: 1px solid #334155; padding: 8px; border-radius: 10px;">
                <option value="1">ì¼ë°˜ ëª¨ë“œ (ê· í˜•)</option>
                <option value="1.5">í•˜ë“œ ëª¨ë“œ (ê¸‰ë³€)</option>
            </select>
        </div>
        <button class="menu-btn" onclick="startGame()">â–¶ ê²Œì„ ì‹œì‘</button>
        <button class="menu-btn" onclick="showModal('shop-modal')">ğŸ›’ ì—…ì  ìƒì </button>
        <button class="menu-btn" onclick="showModal('guide-modal')">ğŸ“– ê²Œì„ ê°€ì´ë“œ</button>
        <button class="menu-btn" onclick="showModal('achieve-modal')">ğŸ† ë‹¬ì„± ì—…ì </button>
        <div class="point-display">ë³´ìœ  í¬ì¸íŠ¸: <span id="user-points">0</span> AP</div>
    </div>

    <div id="game-wrapper">
        <div id="game-main">
            <div id="stat-header">
                <div id="box-pros" class="stat-box">ğŸ’° <span id="v-pros" class="stat-val">50</span><div class="bar-container"><div id="b-pros" class="bar-fill" style="background:var(--pros)"></div></div></div>
                <div id="box-nat" class="stat-box">ğŸŒ³ <span id="v-nat" class="stat-val">50</span><div class="bar-container"><div id="b-nat" class="bar-fill" style="background:var(--nat)"></div></div></div>
                <div id="box-har" class="stat-box">ğŸ¤ <span id="v-har" class="stat-val">50</span><div class="bar-container"><div id="b-har" class="bar-fill" style="background:var(--har)"></div></div></div>
                <div id="box-sec" class="stat-box">ğŸ›¡ï¸ <span id="v-sec" class="stat-val">50</span><div class="bar-container"><div id="b-sec" class="bar-fill" style="background:var(--sec)"></div></div></div>
            </div>
            <div id="turn-display" style="font-weight: 800; color: #64748b; margin-bottom: 8px;">DAY 1 / 15</div>
            <div id="card-zone">
                <div id="main-card" class="card">
                    <div id="c-title" class="card-header-title">ì‹œì‘</div>
                    <div id="c-accent" class="card-top-bar"></div>
                    <div class="card-content">
                        <div id="c-img" class="card-img">ğŸ™ï¸</div>
                        <p id="c-desc"></p>
                    </div>
                </div>
            </div>
            <div id="inventory">
                <div class="inv-slot" title="ìˆ˜ì¹˜ +10" onclick="useItem('UP')">ğŸ§ª<div class="inv-count" id="count-UP">0</div></div>
                <div class="inv-slot" title="ìˆ˜ì¹˜ -10" onclick="useItem('DOWN')">ğŸ“‰<div class="inv-count" id="count-DOWN">0</div></div>
                <div class="inv-slot" title="ë¶€í™œ" style="cursor:help">ğŸ’–<div class="inv-count" id="count-LIFE">0</div></div>
                <div class="inv-slot" title="íŠ¹ë³„ì‚¬ê±´" onclick="useItem('EVENT')">ğŸ«<div class="inv-count" id="count-EVENT">0</div></div>
            </div>
            <div class="btn-group" style="display:flex; gap:10px; width:100%;">
                <button id="btn-L" class="choice-btn" onclick="handleChoice('L')">ê±°ì ˆ</button>
                <button id="btn-M" class="choice-btn" onclick="handleChoice('M')">ì¤‘ë¦½</button>
                <button id="btn-R" class="choice-btn" onclick="handleChoice('R')">ìŠ¹ì¸</button>
            </div>
        </div>
        <div id="game-log-panel">
            <div id="log-header">ğŸ“œ í†µì¹˜ ì—°ëŒ€ê¸°</div>
            <div id="log-content"></div>
        </div>
    </div>

    <div id="guide-modal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>ğŸ“– ê²Œì„ ê°€ì´ë“œ</h2>
            <div style="margin:20px 0; color:#cbd5e1; line-height:1.7; font-size:0.95rem;">
                â€¢ 15ì¼ê°„ 4ê°€ì§€ ìˆ˜ì¹˜ë¥¼ **1~99** ì‚¬ì´ë¡œ ìœ ì§€í•˜ì„¸ìš”.<br>
                â€¢ 0ì´ë‚˜ 100ì´ ë˜ë©´ ì¦‰ì‹œ ë¬¸ëª…ì´ ë¶•ê´´í•©ë‹ˆë‹¤.<br>
                â€¢ **ë¯¸ìŠ¤í„°ë¦¬ ì¹´ë“œ**ëŠ” 3ê°€ì§€ ë¬¸ ì¤‘ í•˜ë‚˜ë¥¼ ê³ ë¥´ëŠ” ë„ë°•ì…ë‹ˆë‹¤.<br>
                â€¢ ìƒì ì—ì„œ **ë¶€í™œ(ğŸ’–)**ì„ ë¯¸ë¦¬ ì‚¬ë‘ë©´ 1ë²ˆì˜ ì‹¤ìˆ˜ë¥¼ ë§ŒíšŒí•©ë‹ˆë‹¤.
            </div>
            <button class="menu-btn" style="width:100%;" onclick="closeModal()">ì´í•´í–ˆìŠµë‹ˆë‹¤</button>
        </div>
    </div>

    <div id="shop-modal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 style="color:var(--pros); margin-bottom:15px;">ğŸ›’ ì—…ì  ìƒì </h2>
            <div id="shop-items-list"></div>
            <button class="menu-btn" style="width:100%; margin-top:10px;" onclick="closeModal()">ë‚˜ê°€ê¸°</button>
        </div>
    </div>

    <div id="achieve-modal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>ğŸ† ë‹¬ì„± ì—…ì </h2>
            <div id="ach-list" style="margin-top:15px;"></div>
            <button class="menu-btn" style="width:100%; margin-top:15px;" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="game-over-screen" class="screen">
        <h1 id="over-title" style="font-size:3.5rem;">ì—”ë”©</h1>
        <p id="ending-sub" style="color:var(--accent); font-weight:bold; margin-bottom:10px;"></p>
        <div id="over-summary" style="margin: 20px 0; background:rgba(255,255,255,0.05); padding:20px; border-radius:15px; width:340px; line-height:1.6;"></div>
        <div id="infinite-area" style="display:none; margin-bottom:20px;">
            <button class="menu-btn" onclick="continueInfinite()" style="background:var(--nat)">ë¬´í•œ ëª¨ë“œ ë„ì „</button>
        </div>
        <button class="menu-btn" onclick="location.reload()">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <script>
        // ì´ë²¤íŠ¸ ë°ì´í„°
        const normalEvents = [
            { title: "í•´ìƒ ë„ì‹œ ê±´ì„¤", icon: "ğŸ™ï¸", theme: "#3b82f6", desc: "í•´ìˆ˜ë©´ ìƒìŠ¹ì— ëŒ€ë¹„í•´ ê±°ëŒ€ í•´ìƒ ë„ì‹œë¥¼ ê±´ì„¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", L: "ìœ¡ì§€ ì§‘ì¤‘", R: "í•´ìƒ ê±´ì„¤", sL: {pros:-10, sec:5}, sR: {pros:20, nat:-15} },
            { title: "ìœ ì „ì í¸ì§‘ ì‹í’ˆ", icon: "ğŸ§¬", theme: "#22c55e", desc: "ê¸°ì•„ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ìœ ì „ì í¸ì§‘ ì‘ë¬¼ì„ ë³´ê¸‰í• ê¹Œìš”?", L: "ì „í†µ ë°©ì‹", R: "ê¸°ìˆ  ë³´ê¸‰", sL: {har:5, pros:-10}, sR: {pros:20, nat:-15} },
            { title: "ì•ˆë“œë¡œì´ë“œ ë…¸ë™ì", icon: "ğŸ¤–", theme: "#fbbf24", desc: "ë…¸ë™ì„ ëŒ€ì²´í•  ì•ˆë“œë¡œì´ë“œë¥¼ ì‚°ì—… í˜„ì¥ì— ë°°ì¹˜í•©ë‹ˆê¹Œ?", L: "ë…¸ë™ ë³´í˜¸", R: "íš¨ìœ¨ ê·¹ëŒ€í™”", sL: {har:15, pros:-15}, sR: {pros:25, har:-20} },
            { title: "ì‹¬í•´ ìì› ì±„êµ´", icon: "âš“", theme: "#3b82f6", desc: "ì‹¬í•´ ê´‘ë¬¼ì„ ì±„êµ´í•˜ì—¬ ë§‰ëŒ€í•œ ë¶€ë¥¼ ì°½ì¶œí•©ì‹œë‹¤.", L: "ìƒíƒœ ë³´ì¡´", R: "ì±„êµ´ ì‹œì‘", sL: {nat:15, pros:-10}, sR: {pros:25, nat:-25} }
        ];
        const guaranteedEvents = [
            { title: "ìš°ì£¼ íƒì‚¬", icon: "ğŸš€", theme: "#3b82f6", type: "EVENT", desc: "ì¸ë¥˜ì˜ ìƒˆë¡œìš´ ì§€í‰ì„ ìœ„í•œ ìš°ì£¼ íƒì‚¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.", L: "í˜„ì‹¤ ì•ˆì£¼", R: "ìš°ì£¼ í•­í•´", sL: {pros:5}, sR: {pros:30, nat:-20} },
            { title: "AI íŠ¹ì´ì ", icon: "ğŸ§ ", theme: "#8b5cf6", type: "EVENT", desc: "ì§€ëŠ¥ì„ ì´ˆì›”í•œ AIì—ê²Œ í†µì œê¶Œì„ ë§¡ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?", L: "ì¸ê°„ ì¤‘ì‹¬", R: "AI í†µì¹˜", sL: {sec:10}, sR: {pros:40, har:-30} }
        ];

        // ì—…ì  20ê°œ (10~40 AP ì„ì˜ ë°°ì •)
        const achDB = [
            { id: 1, name: "ì´ˆë³´ ì„¤ê³„ì", desc: "15ì¼ í†µì¹˜ ì™„ë£Œ", pt: 10, cond: (s, t) => t > 15 },
            { id: 2, name: "í™©ê¸ˆì˜ ì†", desc: "ê²½ì œ 90 ì´ìƒ", pt: 20, cond: (s) => s.pros >= 90 },
            { id: 3, name: "ìì—°ì˜ ìˆ˜í˜¸ì", desc: "ìì—° 90 ì´ìƒ", pt: 20, cond: (s) => s.nat >= 90 },
            { id: 4, name: "í‰í™”ì£¼ì˜ì", desc: "í™”í•© 90 ì´ìƒ", pt: 20, cond: (s) => s.har >= 90 },
            { id: 5, name: "ì² í†µ ë³´ì•ˆ", desc: "ë³´ì•ˆ 90 ì´ìƒ", pt: 20, cond: (s) => s.sec >= 90 },
            { id: 6, name: "ë„ë°•ì‚¬", desc: "ë¯¸ìŠ¤í„°ë¦¬ ì¹´ë“œ ëŒ€ì„±ê³µ", pt: 30, cond: (s, t, l) => l.some(m => m.includes("ëŒ€ì„±ê³µ")) },
            { id: 7, name: "ë¶ˆì‚¬ì‹ ", desc: "ë¶€í™œ ì•„ì´í…œ ì‚¬ìš©", pt: 15, cond: (s, t, l) => l.some(m => m.includes("ë¶€í™œ")) },
            { id: 8, name: "í’ìš”ë¡œìš´ ì„¸ìƒ", desc: "ëª¨ë“  ìˆ˜ì¹˜ 60 ì´ìƒ", pt: 40, cond: (s) => s.pros >= 60 && s.nat >= 60 && s.har >= 60 && s.sec >= 60 },
            { id: 9, name: "ë²¼ë‘ ë í†µì¹˜", desc: "ìˆ˜ì¹˜ 5 ì´í•˜ì—ì„œ ìƒì¡´", pt: 35, cond: (s) => Object.values(s).some(v => v <= 5) },
            { id: 10, name: "ê²€ì†Œí•œ ì„¤ê³„ì", desc: "ì•„ì´í…œ ì—†ì´ 15ì¼ ë²„í‹°ê¸°", pt: 30, cond: (s, t, l) => t > 15 && !l.some(m => m.includes("ì‚¬ìš©")) },
            { id: 11, name: "ìš°ì£¼ ì‹œëŒ€", desc: "ìš°ì£¼ íƒì‚¬ ìŠ¹ì¸", pt: 15, cond: (s, t, l) => l.some(m => m.includes("ìš°ì£¼ í•­í•´")) },
            { id: 12, name: "AI ì‹ ", desc: "AI í†µì¹˜ ìŠ¹ì¸", pt: 15, cond: (s, t, l) => l.some(m => m.includes("AI í†µì¹˜")) },
            { id: 13, name: "ë¬´í•œì˜ ì—¬í–‰ì", desc: "ë¬´í•œ ëª¨ë“œ ì§„ì…", pt: 25, cond: (s, t) => t > 16 },
            { id: 14, name: "ì§ ëŒì´", desc: "í¬ì¸íŠ¸ 100 ë³´ìœ ", pt: 20, cond: () => points >= 100 },
            { id: 15, name: "ì‚¬ê±´ ë§¤ë‹ˆì•„", desc: "ì´ë²¤íŠ¸ ì•„ì´í…œ ì‚¬ìš©", pt: 15, cond: (s, t, l) => l.some(m => m.includes("ì‚¬ê±´ì˜ ê· ì—´")) },
            { id: 16, name: "ê·¹ë‹¨ì  íš¨ìœ¨", desc: "ê²½ì œ 95 ì´ìƒ ë‹¬ì„±", pt: 25, cond: (s) => s.pros >= 95 },
            { id: 17, name: "ì¬ì•™ì˜ ë‚ ", desc: "ë¯¸ìŠ¤í„°ë¦¬ ì¹´ë“œ ëŒ€ì‹¤íŒ¨", pt: 10, cond: (s, t, l) => l.some(m => m.includes("ëŒ€ì‹¤íŒ¨")) },
            { id: 18, name: "ê³ ë…í•œ ì„¤ê³„ì", desc: "í•˜ë“œ ëª¨ë“œ í´ë¦¬ì–´", pt: 40, cond: (s, t) => t > 15 && diff > 1 },
            { id: 19, name: "ê· í˜•ì˜ ìˆ˜í˜¸ì", desc: "ëª¨ë“  ìˆ˜ì¹˜ ì°¨ì´ 10 ì´ë‚´", pt: 30, cond: (s) => Math.max(...Object.values(s)) - Math.min(...Object.values(s)) <= 10 },
            { id: 20, name: "ì „ì„¤ì  ì„¤ê³„ì", desc: "30ì¼ ìƒì¡´", pt: 40, cond: (s, t) => t >= 30 }
        ];

        const shopDB = [
            { id: 'UP', name: "ìƒìŠ¹ ë¹„ì•½", desc: "ìˆ˜ì¹˜ +10", cost: 5, icon: "ğŸ§ª" },
            { id: 'DOWN', name: "ì¡°ì ˆ ì¶”", desc: "ìˆ˜ì¹˜ -10", cost: 5, icon: "ğŸ“‰" },
            { id: 'LIFE', name: "ë¶€í™œ ê¹ƒí„¸", desc: "ë¶•ê´´ ì‹œ ë¶€í™œ", cost: 30, icon: "ğŸ’–" },
            { id: 'EVENT', name: "ì‚¬ê±´ì˜ ê· ì—´", desc: "íŠ¹ë³„ì‚¬ê±´ ì¶”ê°€", cost: 20, icon: "ğŸ«" }
        ];

        // ê²Œì„ ìƒíƒœ
        let stats = { pros: 50, nat: 50, har: 50, sec: 50 };
        let inventory = { UP: 0, DOWN: 0, LIFE: 0, EVENT: 0 };
        let points = parseInt(localStorage.getItem('design_pts') || '0');
        let unlockedAch = JSON.parse(localStorage.getItem('design_ach_list') || '[]');
        let turn = 1, diff = 1, isInfinite = false;
        let pool = [], logHistory = [], mysteryLogic = [];
        let usedMystery = false, usedGuaranteed = false;

        function init() {
            document.getElementById('user-points').innerText = points;
            renderShop();
            renderAch();
        }

        function startGame() {
            diff = parseFloat(document.getElementById('difficulty-select').value);
            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('game-wrapper').classList.add('active');
            resetGame();
        }

        function resetGame() {
            stats = { pros: 50, nat: 50, har: 50, sec: 50 };
            turn = 1; isInfinite = false; usedMystery = false; usedGuaranteed = false;
            pool = [...normalEvents].sort(() => Math.random() - 0.5);
            logHistory = [];
            document.getElementById('log-content').innerHTML = '';
            updateUI();
        }

        function updateUI() {
            for(let k in stats) {
                const val = stats[k];
                document.getElementById(`v-${k}`).innerText = val;
                document.getElementById(`b-${k}`).style.width = Math.max(0, Math.min(100, val)) + '%';
                const box = document.getElementById(`box-${k}`);
                if (val <= 15 || val >= 85) box.classList.add('danger-pulse');
                else box.classList.remove('danger-pulse');
            }
            document.getElementById('turn-display').innerText = `DAY ${turn} ${isInfinite ? '(ë¬´í•œ)' : '/ 15'}`;
            for(let k in inventory) document.getElementById(`count-${k}`).innerText = inventory[k];

            if (!isInfinite && turn > 15) return endGame(true);

            let curr;
            document.getElementById('btn-M').style.display = 'none';

            if (!usedMystery && turn >= 6 && Math.random() < 0.25) {
                curr = { title: "ì‹¬ì—°ì˜ ë¬¸", icon: "ğŸ”®", type: "M_STD", desc: "ì„¸ ë¬¸ ì¤‘ í•˜ë‚˜ë¥¼ íƒí•˜ì„¸ìš”. ìš´ëª…ì´ ê²°ì •ë©ë‹ˆë‹¤.", L: "ì™¼ìª½", M: "ì¤‘ì•™", R: "ì˜¤ë¥¸ìª½" };
                document.getElementById('btn-M').style.display = 'block';
                mysteryLogic = ['LUCK', 'NONE', 'RISK'].sort(() => Math.random() - 0.5);
                usedMystery = true;
            } else if (!usedGuaranteed && turn >= 10 && Math.random() < 0.3) {
                curr = guaranteedEvents[Math.floor(Math.random()*guaranteedEvents.length)];
                usedGuaranteed = true;
            } else {
                curr = pool[turn % pool.length];
            }

            window.currentEvent = curr;
            document.getElementById('c-title').innerText = curr.title;
            document.getElementById('c-desc').innerText = curr.desc;
            document.getElementById('c-img').innerText = curr.icon;
            document.getElementById('c-accent').style.backgroundColor = curr.theme || '#475569';
            document.getElementById('btn-L').innerText = curr.L || "ê±°ì ˆ";
            document.getElementById('btn-R').innerText = curr.R || "ìŠ¹ì¸";
            if (curr.M) document.getElementById('btn-M').innerText = curr.M;
        }

        function handleChoice(dir) {
            const card = document.getElementById('main-card');
            card.classList.add('shake');
            setTimeout(() => card.classList.remove('shake'), 200);

            const curr = window.currentEvent;
            let effect = {};
            let logMsg = "";

            if (curr.type && curr.type === "M_STD") {
                const idx = (dir==='L'?0 : dir==='M'?1 : 2);
                const res = mysteryLogic[idx];
                const key = ['pros','nat','har','sec'][Math.floor(Math.random()*4)];
                if(res==='LUCK') { effect[key]=25; logMsg="ëŒ€ì„±ê³µ"; }
                else if(res==='RISK') { effect[key]=-25; logMsg="ëŒ€ì‹¤íŒ¨"; }
                else logMsg="ë³€í™” ì—†ìŒ";
            } else {
                effect = (dir==='L' ? curr.sL : curr.sR);
                logMsg = (dir==='L' ? curr.L : curr.R);
            }

            for(let k in effect) stats[k] += Math.round(effect[k] * diff);

            if (Object.values(stats).some(v => v <= 0 || v >= 100)) {
                if (inventory.LIFE > 0) {
                    inventory.LIFE--;
                    for(let k in stats) stats[k] = 50;
                    alert("ğŸ’– ë¶€í™œ ë°œë™!"); logMsg += " (ë¶€í™œ)";
                } else return endGame(false);
            }

            addLog(turn, curr.title, logMsg);
            turn++;
            checkAchievements();
            updateUI();
        }

        function endGame(win) {
            closeModal();
            document.getElementById('game-wrapper').style.display = 'none';
            const screen = document.getElementById('game-over-screen');
            screen.classList.add('active');
            screen.style.display = 'flex'; // í™•ì‹¤íˆ ë…¸ì¶œ

            let title="", sub="", desc="";
            if(!win) {
                title="ì„¤ê³„ ì‹¤íŒ¨"; sub="ë¬¸ëª… ë¶•ê´´"; desc="ìˆ˜ì¹˜ê°€ í•œê³„ë¥¼ ë„˜ì–´ ë¬¸ëª…ì´ ë¶•ê´´í–ˆìŠµë‹ˆë‹¤.";
            } else {
                document.getElementById('infinite-area').style.display = 'block';
                if(stats.pros>=80 && stats.sec>=80) { title="ê°•ì² ì˜ ì œêµ­"; sub="ì‚¬ì´ë²„í‘í¬"; desc="ê²½ì œì™€ ì¹˜ì•ˆì€ ì™„ë²½í•˜ë‚˜ ììœ ê°€ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤."; }
                else if(stats.nat>=80 && stats.har>=80) { title="ì—ë´ ë™ì‚°"; sub="ìœ í† í”¼ì•„"; desc="ëª¨ë“  ì¸ë¥˜ê°€ ìì—°ê³¼ í‰í™”ë¡­ê²Œ ê³µì¡´í•©ë‹ˆë‹¤."; }
                else { title="ì•ˆì •ëœ ë¬¸ëª…"; sub="ì„±ê³µì ì¸ ì„¤ê³„"; desc="ë‹¹ì‹ ì€ í›Œë¥­íˆ 15ì¼ì„ ê²¬ëŒëƒˆìŠµë‹ˆë‹¤."; }
            }
            document.getElementById('over-title').innerText = title;
            document.getElementById('ending-sub').innerText = sub;
            document.getElementById('over-summary').innerHTML = `${desc}<hr style="margin:10px 0; opacity:0.2;">ğŸ’°${stats.pros} ğŸŒ³${stats.nat} ğŸ¤${stats.har} ğŸ›¡ï¸${stats.sec}`;
        }

        function continueInfinite() {
            isInfinite = true; diff += 0.2;
            document.getElementById('game-over-screen').classList.remove('active');
            document.getElementById('game-over-screen').style.display = 'none';
            document.getElementById('game-wrapper').classList.add('active');
            updateUI();
        }

        function useItem(type) {
            if(inventory[type]<=0) return;
            if(type==='EVENT') { usedGuaranteed=false; alert("ğŸ« íŠ¹ë³„ ì‚¬ê±´ì´ ë‹¤ì‹œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); }
            else {
                const target = prompt("1.ê²½ì œ 2.ìì—° 3.í™”í•© 4.ë³´ì•ˆ");
                const key = ['pros','nat','har','sec'][parseInt(target)-1];
                if(!key) return;
                stats[key] += (type==='UP'? 10 : -10);
            }
            inventory[type]--;
            addLog(turn, "ì•„ì´í…œ", `${type} ì‚¬ìš©`);
            updateUI();
        }

        function buyItem(id) {
            const item = shopDB.find(i=>i.id===id);
            if(points>=item.cost) {
                points-=item.cost; inventory[id]++; saveData(); renderShop(); alert("êµ¬ë§¤ ì™„ë£Œ!");
            } else alert("í¬ì¸íŠ¸ ë¶€ì¡±!");
        }

        function checkAchievements() {
            achDB.forEach(ach => {
                if(!unlockedAch.includes(ach.id) && ach.cond(stats, turn, logHistory)) {
                    unlockedAch.push(ach.id); points+=ach.pt; saveData(); alert(`ğŸ† ì—…ì  ë‹¬ì„±: ${ach.name}`);
                }
            });
        }

        function saveData() {
            localStorage.setItem('design_pts', points);
            localStorage.setItem('design_ach_list', JSON.stringify(unlockedAch));
            document.getElementById('user-points').innerText = points;
        }

        function addLog(d, title, action) {
            logHistory.push(action);
            const entry = document.createElement('div');
            entry.innerHTML = `<strong>DAY ${d}</strong> ${title}: ${action}`;
            document.getElementById('log-content').prepend(entry);
        }

        function renderShop() {
            let h = '';
            shopDB.forEach(i => h += `<div class="shop-item">
                <div><b>${i.icon} ${i.name}</b><br><small>${i.desc}</small></div>
                <button class="menu-btn" style="width:70px; padding:5px; font-size:0.8rem;" onclick="buyItem('${i.id}')">${i.cost}pt</button>
            </div>`);
            document.getElementById('shop-items-list').innerHTML = h;
        }

        function renderAch() {
            let h = '';
            achDB.forEach(a => h += `<div style="padding:10px; border-bottom:1px solid #334155; opacity:${unlockedAch.includes(a.id)?1:0.3}">
                ${unlockedAch.includes(a.id)?'âœ…':'ğŸ”’'} <b>${a.name}</b> (${a.pt}pt)<br>${a.desc}
            </div>`);
            document.getElementById('ach-list').innerHTML = h;
        }

        function showModal(id) { document.getElementById(id).style.display = 'flex'; if(id==='achieve-modal') renderAch(); }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }

        init();
    </script>
</body>
</html>
